<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.zippy.move.mapper.MoveMapper">

	<insert id="moveUntactCheck" parameterType="MoveRequestVO">
		<selectKey keyProperty="estimateNo" order="BEFORE" resultType="int">
			SELECT NVL(MAX(estimate_no),0) +1 AS estimateNo 
			FROM UNTACT_ESTIMATE_MOVING
		</selectKey>
		INSERT INTO UNTACT_ESTIMATE_MOVING
		(
		ESTIMATE_NO,
		EMAIL,
		MOVING_OPTION,
		MOVING_MEMO,
		DEPART_ADDRESS,
		ARRIVE_ADDRESS,
		MOVING_DATE,
		MOVING_TIME,
		ESTIMATE_TYPE,
		DEPART_ZIP_CODE,
		DEPART_DETAIL,
		DEPART_EXTRA,
		ARRIVE_ZIP_CODE,
		ARRIVE_DETAIL,
		ARRIVE_EXTRA,
		MOVE_TYPE,
		REQUEST_DATE,
		VISIT_DATE,
		VISIT_TIME,
		COMMON_OPTION
		)
		VALUES
		(
		#{estimateNo},
		#{email},
		#{movingOption},
		#{movingMemo},
		#{departAddress},
		#{arriveAddress},
		#{movingDate},
		#{movingTime},
		#{estimateType},
		#{departZipCode},
		#{departDetail},
		#{departExtra},
		#{arriveZipCode},
		#{arriveDetail},
		#{arriveExtra},
		#{moveType},
		#{requestDate},
		#{visitDate},
		#{visitTime},
		#{commonOption}
		)
	</insert>
	
	<insert id="insertPhoto" parameterType="MoveRequestVO">
		<selectKey keyProperty="houseImgNo" order="BEFORE" resultType="int">
			SELECT NVL(MAX(house_img_no),0) +1 AS houseImgNo 
			FROM UNTACT_HOUSE_IMAGE
		</selectKey>
		
		INSERT INTO UNTACT_HOUSE_IMAGE
		(
		HOUSE_IMG_NO,
		ESTIMATE_NO,
		HOUSE_IMG,
		IMG_TYPE
		)
		VALUES
		(
		#{houseImgNo},
		#{estimateNo},
  		#{houseImg},
  		#{imgType}
		)
	</insert>
	
	<insert id="insertContactEstimate" parameterType="MoveRequestVO">
		<selectKey keyProperty="estimateNo" order="BEFORE" resultType="int">
			SELECT NVL(MAX(estimate_no),0) +1 AS estimateNo 
			FROM UNTACT_ESTIMATE_MOVING
		</selectKey>
		INSERT INTO UNTACT_ESTIMATE_MOVING
		(
		ESTIMATE_NO,
		EMAIL,
		MOVING_OPTION,
		MOVING_MEMO,
		DEPART_ADDRESS,
		ARRIVE_ADDRESS,
		MOVING_DATE,
		MOVING_TIME,
		ESTIMATE_TYPE,
		DEPART_ZIP_CODE,
		DEPART_DETAIL,
		DEPART_EXTRA,
		ARRIVE_ZIP_CODE,
		ARRIVE_DETAIL,
		ARRIVE_EXTRA,
		MOVE_TYPE,
		REQUEST_DATE,
		VISIT_DATE,
		VISIT_TIME,
		COMMON_OPTION
		)
		VALUES
		(
		#{estimateNo},
		#{email},
		#{movingOption},
		#{movingMemo},
		#{departAddress},
		#{arriveAddress},
		#{movingDate},
		#{movingTime},
		#{estimateType},
		#{departZipCode},
		#{departDetail},
		#{departExtra},
		#{arriveZipCode},
		#{arriveDetail},
		#{arriveExtra},
		#{moveType},
		#{requestDate},
		#{visitDate},
		#{visitTime},
		#{commonOption}
		)
	</insert>
	
	<insert id="makeEstimate" parameterType="MoveResponseVO" useGeneratedKeys="true">
		<selectKey keyProperty="movingResponseNo"  order="BEFORE" resultType="int">
			SELECT NVL(MAX(MOVING_RESPONSE_NO),0) +1 AS movingResponseNo 
			FROM MOVING_RESPONSE
		</selectKey>
			INSERT INTO MOVING_RESPONSE
			(
			MOVING_RESPONSE_NO,
			ESTIMATE_NO,
			EMAIL,
			FIRST_ESTIMATE_PRICE,
			FIRST_ESTIMATE_TYPE,
			SECOND_ESTIMATE_PRICE,
			SECOND_ESTIMATE_TYPE,
			RESERV_STATUS,
			COMP_NAME,
			RESPONSE_MEMO
			)
			VALUES
			(
			#{movingResponseNo},
			#{estimateNo},
			#{email},	
			#{firstEstimatePrice},
			#{firstEstimateType},
			#{secondEstimatePrice},
			#{secondEstimateType},
			#{reservStatus},
			#{compName},
			#{responseMemo}
			)
	</insert>
	
	
	<!-- 업체가 들어온 견적 전체조회 -->
	<select id="getEstimateList" parameterType="MoveEstimateVO" resultType="MoveRequestVO">
		SELECT *
		FROM untact_estimate_moving
		WHERE email=#{email}
		<if test="dropbox2 == '내 지역만 조회'">
		AND SUBSTR(depart_address, 1, 2) LIKE '%'||
		(SELECT SUBSTR(comp_address, 1,2)
		FROM business
		WHERE email ='move123@move.com') || '%'
		
		<!-- AND estimate_type LIKE '%'||#{estimateType}||'%' -->
		<!-- <if test="dropbox == '전체조회'">
	
		
		</if> -->
		</if>
		<if test="dropbox == '대면견적'">
		AND estimate_type = '대면견적'
		</if>
		<if test="dropbox == '비대면견적'">
		AND estimate_type = '비대면견적'
		</if>
	
		<if test="dropbox == '현재날짜요청'">
		AND request_date =  TO_CHAR(SYSDATE, 'YYYY.MM.DD')
		</if>
		
		<if test="dropbox == '최신요청일자순'">
		ORDER BY request_date DESC
		</if>
		<if test="dropbox == '오래된요청일자순'">
		ORDER BY request_date ASC
		</if>
		<if test="dropbox == '출발지순'">
		ORDER BY SUBSTR(depart_address, 1, 2) DESC
		</if>
		<if test="dropbox == '도착지순'">
		ORDER BY SUBSTR(arrive_address, 1, 2) DESC
		</if>
		
	</select>
	
	<!-- 전체조회 - 유저가 자기 견적히스토리 조회 -->
	<select id="getEstimateResult" parameterType="MoveEstimateVO" resultType="MoveRequestVO">
		SELECT * FROM
		UNTACT_ESTIMATE_MOVING
		WHERE email=#{email}
		<if test="dropbox == '날짜순'">
		ORDER BY TO_CHAR(request_date, 'YYYY. MM. DD') DESC
		</if>
		<if test="dropbox == '견적방법순'">
		ORDER BY estimate_type DESC, request_date DESC
		</if>
	</select>
</mapper>